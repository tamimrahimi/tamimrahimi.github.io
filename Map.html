<html lang="en">
    <head>
        <style>
            #avails_map_new
            {
                height: 99%;
                width: 99%;
                position: absolute;
            }
        </style>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBeXZM48k1_9vqyoFNzC1bjVm_rWUVQ370">
        </script>
    </head>
    <body>
        <div id="avails_map_new"></div>
    </body>
    <script>
        window.addEventListener('message', (event) => {
            if(event.data.jsonLatLng) {
                var latLong = JSON.parse(event.data.jsonLatLng)
                initializeMap(latLong);
            }
        });
        
        function initializeMap(latLong) {
            var _map = null;
            var _markerinfowindow;
            var myOptions = {
                zoom: 5,
                center: latLong,
                zoomControl: true,
                streetViewControl: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                fullscreenControl: true,
                fullscreenControlOptions: {
                    position: google.maps.ControlPosition.LEFT_TOP
                }
            };
    
            var div = document.getElementById('avails_map_new');
            _map = new google.maps.Map(div, myOptions);

            var clearControlDiv = document.createElement('div');
            clearControlDiv.setAttribute("id", "clearSearch");
            var radiusControlDiv = document.createElement('div');
            radiusControlDiv.setAttribute("id", "radiusControl");
            
            clearControlDiv.index = 1;
            _map.controls[google.maps.ControlPosition.RIGHT_TOP].push(clearControlDiv);

            radiusControlDiv.index = 1;
            _map.controls[google.maps.ControlPosition.TOP_RIGHT].push(radiusControlDiv);

            _markerinfowindow = new google.maps.InfoWindow({
                content: '',
                width: 300,
                height: 200
            });

            google.maps.event.addListener(_markerinfowindow, 'closeclick', function () {
                _siteID = null;
            });

            google.maps.event.addListener(_map, 'mousedown', function () {
                toggleMarker();
                $('#avails_map_list table tr').removeClass('hover');
            });
            
            const jsonMap = JSON.stringify(_map, refReplacer());
            event.source.postMessage({jsonMap}, "https://tamimrahimi.github.io/");
        }

        function refReplacer() {
            let m = new Map(), v= new Map(), init = null;
            return function(field, value) {
                let p= m.get(this) + (Array.isArray(this) ? `[${field}]` : '.' + field);
                let isComplex= value===Object(value)
                if (isComplex) m.set(value, p);
                let pp = v.get(value)||'';
                let path = p.replace(/undefined\.\.?/,'');
                let val = pp ? `#REF:${pp[0]=='[' ? '$':'$.'}${pp}` : value;
                !init ? (init=value) : (val===init ? val="#REF:$" : 0);
                if(!pp && isComplex) v.set(value, path);

                return val;
            }
        }

        function toggleMarker(marker) {
            $.map(_mapMarkers, function (val) {
                if (val.getAnimation() != null)
                    val.setAnimation(null);
            });
            if (!isUndefined(marker))
                marker.setAnimation(google.maps.Animation.BOUNCE);
        }
        // function initAutocompleteSearch() {
        //     // Create the search box and link it to the UI element.
        //     var input = document.getElementById('pac-input');
        //     var searchBox = new google.maps.places.SearchBox(input);
        //     _map.controls[google.maps.ControlPosition.TOP_RIGHT].push(input);
        //
        //
        //
        //     // Bias the SearchBox results towards current map's viewport.
        //     _map.addListener('bounds_changed', function () {
        //         searchBox.setBounds(_map.getBounds());
        //     });
        //
        //     // Listen for the event fired when the user selects a prediction and retrieve
        //     // more details for that place.
        //     searchBox.addListener('places_changed', function () {
        //         var places = searchBox.getPlaces();
        //
        //         if (places.length == 0) {
        //             return;
        //         }
        //
        //         // For each place, get the icon, name and location.
        //         var bounds = new google.maps.LatLngBounds();
        //         places.forEach(function (place) {
        //             if (!place.geometry) {
        //                 console.log("Returned place contains no geometry");
        //                 return;
        //             }
        //             var icon = {
        //                 url: place.icon,
        //                 size: new google.maps.Size(71, 71),
        //                 origin: new google.maps.Point(0, 0),
        //                 anchor: new google.maps.Point(17, 34),
        //                 scaledSize: new google.maps.Size(25, 25)
        //             };
        //
        //             // Create a marker for each place.
        //             markers.push(new google.maps.Marker({
        //                 map: _map,
        //                 icon: icon,
        //                 title: place.name,
        //                 position: place.geometry.location
        //             }));
        //
        //             if (place.geometry.viewport) {
        //                 // Only geocodes have viewport.
        //                 bounds.union(place.geometry.viewport);
        //             } else {
        //                 bounds.extend(place.geometry.location);
        //             }
        //         });
        //         _map.fitBounds(bounds);
        //         updateCircles(circles);
        //     });
        // }

    </script>
</html>
